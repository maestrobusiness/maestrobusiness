<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAESTRO - FUEL CAPITAL ANALISYS</title>
  <style>
    :root{
      --bg: #062a1f;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --line: rgba(255,255,255,.14);

      --yellow: #f2c94c;
      --gold: #d4af37;
      --gold2: #b38f2a;

      --good: #55efc4;
      --bad: #ff7675;
      --warn: #ffeaa7;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(212,175,55,.10), transparent 60%),
                  radial-gradient(900px 700px at 90% 30%, rgba(242,201,76,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(6,42,31,.95), rgba(6,42,31,.82));
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(8px);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0 6px;
    }

    .title{
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: 14px;
      color: rgba(255,255,255,.95);
    }

    .subtitle{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .04em;
    }

    .badge{
      padding: 8px 10px;
      border: 1px solid rgba(212,175,55,.35);
      background: linear-gradient(180deg, rgba(212,175,55,.10), rgba(242,201,76,.06));
      border-radius: 999px;
      color: rgba(255,255,255,.92);
      font-size: 12px;
      letter-spacing: .04em;
    }

    .controls{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      padding: 10px 0 14px;
    }

    .leftControls, .rightControls{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
    }

    .segmented{
      display:flex;
      gap: 6px;
      padding: 6px;
      background: rgba(0,0,0,.12);
      border: 1px solid var(--line);
      border-radius: 999px;
    }

    .segmented button{
      border: 0;
      cursor: pointer;
      padding: 9px 12px;
      border-radius: 999px;
      color: rgba(255,255,255,.88);
      background: transparent;
      font-weight: 700;
      letter-spacing: .03em;
      font-size: 12px;
      transition: transform .04s ease, background .15s ease, color .15s ease, box-shadow .15s ease;
    }
    .segmented button:hover{ background: rgba(255,255,255,.06); }
    .segmented button:active{ transform: translateY(1px); }
    .segmented button.active{
      background: linear-gradient(180deg, rgba(212,175,55,.26), rgba(242,201,76,.12));
      box-shadow: inset 0 0 0 1px rgba(212,175,55,.30);
      color: rgba(255,255,255,.95);
    }

    select, input{
      background: rgba(0,0,0,.12);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 10px;
      outline: none;
      font-size: 13px;
    }
    input::placeholder{ color: rgba(255,255,255,.55); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      padding: 14px 0 18px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
    }

    .cardHeader{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
    }

    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(255,255,255,.93);
    }

    .hint{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 640px){
      .kpis{ grid-template-columns: 1fr; }
    }

    .kpi{
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.10);
    }
    .kpi .label{
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
      margin-bottom: 6px;
    }
    .kpi .value{
      font-size: 22px;
      font-weight: 850;
      letter-spacing: .02em;
    }
    .kpi .delta{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .pill{
      font-weight: 800;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .pill.good{ border-color: rgba(85,239,196,.35); background: rgba(85,239,196,.08); color: rgba(85,239,196,.95); }
    .pill.bad{  border-color: rgba(255,118,117,.35); background: rgba(255,118,117,.08); color: rgba(255,118,117,.95); }
    .pill.warn{ border-color: rgba(255,234,167,.35); background: rgba(255,234,167,.08); color: rgba(255,234,167,.95); }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: middle;
    }
    th{
      text-align:left;
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      background: rgba(0,0,0,.12);
    }
    tr:hover td{ background: rgba(255,255,255,.03); }
    .right{ text-align:right; }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; }

    .spark{
      width: 120px;
      height: 28px;
      display:block;
    }

    .footerNote{
      margin-top: 10px;
      color: rgba(255,255,255,.62);
      font-size: 12px;
      line-height: 1.4;
    }

    .goldLine{
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.55), transparent);
      margin: 10px 0 0;
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(212,175,55,.28);
      background: linear-gradient(180deg, rgba(212,175,55,.18), rgba(242,201,76,.08));
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: .04em;
      font-size: 12px;
      transition: transform .04s ease, filter .15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ filter: brightness(1.06); }

    .chipRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(212,175,55,.35);
      background: rgba(212,175,55,.12);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div>
          <div class="title">MAESTRO - FUEL CAPITAL ANALISYS</div>
          <div class="subtitle">Painel de indicadores para combustíveis (Brasil) e variáveis que impactam o setor</div>
        </div>
        <div class="badge" id="asOf">As of: —</div>
      </div>

      <div class="controls">
        <div class="leftControls">
          <div class="segmented" aria-label="Filtro de período">
            <button class="active" data-period="D">Diário</button>
            <button data-period="W">Semanal</button>
            <button data-period="M">Mensal</button>
            <button data-period="Y">Anual</button>
          </div>

          <select id="category">
            <option value="ALL">Todas as categorias</option>
            <option value="FUEL">Combustíveis</option>
            <option value="MACRO">Macro</option>
            <option value="FX">Câmbio</option>
            <option value="COMMOD">Commodities</option>
            <option value="LOG">Logística/Distribuição</option>
          </select>

          <input id="search" type="text" placeholder="Buscar indicador (ex.: diesel, IPCA, brent, USD/BRL)" />
        </div>

        <div class="rightControls">
          <button class="btn" id="refreshLive">Atualizar dados (BCB)</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2>Resumo executivo</h2>
            <p class="hint" id="summaryText">—</p>
          </div>
          <div class="small muted" id="periodLabel">Período: Diário</div>
        </div>

        <div class="kpis" id="kpis"></div>

        <div class="goldLine"></div>

        <div class="chipRow" id="quickFilters">
          <div class="chip active" data-preset="CORE">Core Fuel</div>
          <div class="chip" data-preset="PRICES">Preços bomba</div>
          <div class="chip" data-preset="RISK">Risco Brasil</div>
          <div class="chip" data-preset="INPUTS">Insumos</div>
          <div class="chip" data-preset="ALL">Tudo</div>
        </div>

        <p class="footerNote">
          Status: Selic / USDBRL / IPCA 12m são carregados do BCB (SGS). Os demais itens ainda são placeholders (simulação)
          até você plugar ANP/IBGE/externos.
        </p>
      </section>

      <aside class="card">
        <div class="cardHeader">
          <div>
            <h2>Drivers do setor</h2>
            <p class="hint">O que tende a mover margem, demanda e pricing power.</p>
          </div>
        </div>
        <ul class="small" style="margin:0; padding-left: 16px; color: rgba(255,255,255,.82); line-height: 1.55;">
          <li><span style="color: var(--gold); font-weight: 800;">Paridade e referência</span>: Brent/WTI, crack spreads, câmbio.</li>
          <li><span style="color: var(--gold); font-weight: 800;">Regulação</span>: tributos (ICMS/federais), mistura (biodiesel/etanol).</li>
          <li><span style="color: var(--gold); font-weight: 800;">Custo e oferta</span>: frete, capacidade de refino, importação.</li>
          <li><span style="color: var(--gold); font-weight: 800;">Demanda</span>: atividade econômica, PIB, inflação, crédito.</li>
          <li><span style="color: var(--gold); font-weight: 800;">Risco Brasil</span>: juros reais, prêmio de risco, volatilidade.</li>
        </ul>
        <div class="goldLine"></div>
        <p class="footerNote">
          Se um endpoint bloquear CORS, você precisa de um proxy (Cloudflare/Vercel/Netlify). Para BCB (SGS) normalmente funciona direto.
        </p>
      </aside>
    </div>

    <section class="card">
      <div class="cardHeader">
        <div>
          <h2>Indicadores</h2>
          <p class="hint">Ordene por variação e isole o horizonte (D/W/M/Y). Sparklines representam tendência recente.</p>
        </div>
        <div class="small muted" id="countLabel">—</div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px;">Indicador</th>
              <th style="min-width:140px;">Categoria</th>
              <th class="right" style="min-width:120px;">Valor</th>
              <th class="right" style="min-width:120px;">Variação</th>
              <th class="right" style="min-width:140px;">Tendência</th>
              <th style="min-width:220px;">Nota</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ============================================================
    // 1) BASE (placeholders) + 2) BCB live (SGS/BCData) overlays
    // ============================================================

    const INDICATORS = [
      mk("Diesel S10 (bomba) - R$/L", "FUEL", 6.15, "Placeholder (ANP ainda não plugado)", trend(18, 6.0, 6.4)),
      mk("Gasolina (bomba) - R$/L", "FUEL", 5.75, "Placeholder (ANP ainda não plugado)", trend(18, 5.5, 5.95)),
      mk("Etanol hidratado (bomba) - R$/L", "FUEL", 3.85, "Placeholder (ANP ainda não plugado)", trend(18, 3.7, 4.05)),

      // BCB / Macro & FX (estes serão substituídos por dados reais)
      mk("IPCA (12m) - %", "MACRO", 4.5, "BCB/SGS (ao vivo)", trend(18, 3.9, 4.9), true),
      mk("Selic meta - % a.a.", "MACRO", 11.25, "BCB/SGS (ao vivo)", trend(18, 10.8, 12.1), true),
      mk("USD/BRL (livre, venda)", "FX", 5.05, "BCB/SGS (ao vivo)", trend(18, 4.8, 5.25)),

      // Outros (placeholders até plugar fontes externas)
      mk("Brent (USD/bbl)", "COMMOD", 82.0, "Placeholder (fonte externa)", trend(18, 76, 88)),
      mk("WTI (USD/bbl)", "COMMOD", 78.0, "Placeholder (fonte externa)", trend(18, 72, 85)),
      mk("Frete rodoviário (índice)", "LOG", 102.0, "Placeholder (fonte externa)", trend(18, 98, 106), true),
    ];

    // períodos: D/W/M/Y (variação percentual)
    const PERIODS = {
      D: { label: "Diário",  points: 1  },   // 1 ponto atrás
      W: { label: "Semanal", points: 5  },   // ~5 dias úteis
      M: { label: "Mensal",  points: 21 },   // ~21 dias úteis
      Y: { label: "Anual",   points: 252 },  // ~252 dias úteis
    };

    // presets (filtro rápido)
    const PRESETS = {
      CORE:  (x) => ["Diesel", "Gasolina", "USD/BRL", "Brent", "Selic"].some(k => x.name.includes(k)),
      PRICES:(x) => x.name.toLowerCase().includes("bomba"),
      RISK:  (x) => ["Selic", "IPCA", "USD/BRL"].some(k => x.name.includes(k)),
      INPUTS:(x) => ["Brent", "WTI", "Frete"].some(k => x.name.includes(k)),
      ALL:   (_) => true
    };

    function mk(name, category, value, note, series, invertColor=false){
      return {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
        name, category, value, note,
        series,
        invertColor,
        changes: { D: 0, W: 0, M: 0, Y: 0 },
        isLive: false
      };
    }

    function trend(n, min, max){
      const arr = [];
      let v = min + Math.random()*(max-min);
      for(let i=0;i<n;i++){
        v += (Math.random()-0.5) * (max-min) * 0.10;
        v = Math.max(min, Math.min(max, v));
        arr.push(v);
      }
      return arr;
    }

    function fmt(val){
      return Number(val).toLocaleString("pt-BR", { maximumFractionDigits: 4 });
    }

    function nowStamp(){
      return new Date().toLocaleString("pt-BR");
    }

    function round2(x){ return Math.round(x*100)/100; }
    function round4(x){ return Math.round(x*10000)/10000; }

    // ============================================================
    // 2) BCB LIVE (SGS/BCData)
    // ============================================================
    // Mapeamento SGS -> Indicador no painel
    // Selic meta: 432
    // USD/BRL (livre, venda): 1
    // IPCA em 12 meses: 13522
    const BCB_SERIES = [
      { sgs: 432,   name: "Selic meta - % a.a.",          decimals: 2 },
      { sgs: 1,     name: "USD/BRL (livre, venda)",       decimals: 4 },
      { sgs: 13522, name: "IPCA (12m) - %",               decimals: 2 },
    ];

    function toDDMMYYYY(d){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    async function fetchBCBSeries(seriesCode, startDate, endDate){
      const url =
        `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${seriesCode}/dados` +
        `?formato=json&dataInicial=${encodeURIComponent(startDate)}` +
        `&dataFinal=${encodeURIComponent(endDate)}`;

      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`BCB fetch failed (SGS ${seriesCode}) => ${res.status}`);
      const json = await res.json(); // [{data:"dd/mm/aaaa", valor:"x.xx"}, ...]
      return json
        .map(p => ({
          date: p.data,
          value: Number(String(p.valor).replace(",", ".")),
        }))
        .filter(p => Number.isFinite(p.value));
    }

    function lastN(points, n){
      if(!points.length) return [];
      return points.slice(Math.max(0, points.length - n));
    }

    function pctChange(points, lookback){
      if(points.length < lookback + 1) return 0;
      const last = points[points.length - 1].value;
      const prev = points[points.length - 1 - lookback].value;
      if(!isFinite(prev) || prev === 0) return 0;
      return ((last - prev) / prev) * 100;
    }

    function absChange(points, lookback){
      if(points.length < lookback + 1) return 0;
      const last = points[points.length - 1].value;
      const prev = points[points.length - 1 - lookback].value;
      return (last - prev);
    }

    function setChangesForIndicator(ind, series){
      // Regra:
      // - Para taxa/inflação (Selic/IPCA): usar variação ABS (p.p.) é mais lógico do que %.
      // - Para câmbio (USD/BRL): variação % é ok.
      const isRateLike = ind.name.includes("Selic") || ind.name.includes("IPCA");

      Object.entries(PERIODS).forEach(([k, meta]) => {
        const pts = meta.points;
        const raw = isRateLike ? absChange(series, pts) : pctChange(series, pts);
        ind.changes[k] = round2(raw);
      });
    }

    async function hydrateFromBCB(){
      // janela grande o suficiente para suportar Y (~252 pontos) em séries diárias
      // e também séries mensais (IPCA 12m) sem quebrar.
      const end = new Date();
      const start = new Date();
      start.setFullYear(start.getFullYear() - 3);

      const dataInicial = toDDMMYYYY(start);
      const dataFinal = toDDMMYYYY(end);

      for(const m of BCB_SERIES){
        const series = await fetchBCBSeries(m.sgs, dataInicial, dataFinal);
        const ind = INDICATORS.find(x => x.name === m.name);
        if(!ind || !series.length) continue;

        // atualizar valor e sparkline
        ind.value = series[series.length - 1].value;
        ind.series = lastN(series, 18).map(p => p.value);

        // calcular mudanças (D/W/M/Y)
        setChangesForIndicator(ind, series);

        ind.isLive = true;
      }

      document.getElementById("asOf").textContent = "As of: " + nowStamp();
    }

    // ============================================================
    // 3) ESTADO / FILTROS
    // ============================================================
    let state = {
      period: "D",
      category: "ALL",
      search: "",
      preset: "CORE"
    };

    // ============================================================
    // 4) RENDER
    // ============================================================
    function render(){
      const period = state.period;
      document.getElementById("periodLabel").textContent = "Período: " + PERIODS[period].label;

      const filtered = INDICATORS
        .filter(x => state.category === "ALL" ? true : x.category === state.category)
        .filter(x => state.search.trim() === "" ? true : (
          (x.name + " " + x.note).toLowerCase().includes(state.search.trim().toLowerCase())
        ))
        .filter(x => PRESETS[state.preset](x))
        .map(x => ({...x, change: x.changes[period]}));

      // ordenar por magnitude da variação
      filtered.sort((a,b) => Math.abs(b.change) - Math.abs(a.change));

      document.getElementById("countLabel").textContent = `${filtered.length} indicador(es)`;

      renderTable(filtered, period);
      renderKPIs(filtered, period);
      renderSummary(filtered, period);
    }

    function renderSummary(list, period){
      const label = PERIODS[period].label.toLowerCase();
      if(list.length === 0){
        document.getElementById("summaryText").textContent =
          "Sem indicadores com os filtros atuais. Remova filtros ou troque o preset.";
        return;
      }

      const top = list[0];
      const pos = list.filter(x => x.change > 0).length;
      const neg = list.filter(x => x.change < 0).length;
      const flat = list.length - pos - neg;

      const focus = top.invertColor
        ? "Alta em variável sensível (pode pressionar margens)."
        : "Movimento relevante em driver potencialmente favorável.";

      const liveTag = top.isLive ? " (BCB)" : " (placeholder)";

      document.getElementById("summaryText").textContent =
        `No horizonte ${label}, ${pos} sobem, ${neg} caem e ${flat} estáveis. ` +
        `Maior movimento: ${top.name}${liveTag} (${fmtChange(top.change, top)}). ${focus}`;
    }

    function renderKPIs(list, period){
      const el = document.getElementById("kpis");
      el.innerHTML = "";

      const avg = list.reduce((s,x)=>s+x.change,0) / Math.max(1, list.length);
      const vol = Math.sqrt(list.reduce((s,x)=>s+Math.pow(x.change-avg,2),0)/Math.max(1,list.length));

      const best = [...list].sort((a,b)=>score(b)-score(a))[0];
      const worst = [...list].sort((a,b)=>score(a)-score(b))[0];

      const kpis = [
        {
          label: "Maior sinal (ajustado)",
          value: best ? fmt(best.value) : "—",
          delta: best ? `${best.name} • ${fmtChange(best.change, best)}` : "—",
          pill: best ? pillFor(best) : {text:"—", cls:"warn"}
        },
        {
          label: "Maior pressão (ajustado)",
          value: worst ? fmt(worst.value) : "—",
          delta: worst ? `${worst.name} • ${fmtChange(worst.change, worst)}` : "—",
          pill: worst ? pillFor(worst, true) : {text:"—", cls:"warn"}
        },
        {
          label: "Dispersão do painel",
          value: isFinite(vol) ? fmt(round2(vol)) + " pts" : "—",
          delta: `Média: ${fmt(round2(avg))} • Horizonte: ${PERIODS[period].label}`,
          pill: {text: vol>3 ? "VOL ALTA" : vol>1.5 ? "VOL MÉDIA" : "VOL BAIXA", cls: vol>3 ? "bad" : vol>1.5 ? "warn" : "good"}
        },
      ];

      kpis.forEach(k => el.appendChild(kpiCard(k)));
    }

    function score(x){
      return x.invertColor ? -x.change : x.change;
    }

    function pillFor(x, forWorst=false){
      const s = score(x);
      const isGood = forWorst ? (s >= 0) : (s > 0);
      const isBad  = forWorst ? (s < 0) : (s < 0);

      if(isGood) return { text: x.isLive ? "LIVE" : "FAVORÁVEL", cls: "good" };
      if(isBad)  return { text: x.isLive ? "LIVE" : "PRESSÃO", cls: "bad" };
      return { text: x.isLive ? "LIVE" : "NEUTRO", cls: "warn" };
    }

    function kpiCard({label, value, delta, pill}){
      const d = document.createElement("div");
      d.className = "kpi";
      d.innerHTML = `
        <div class="label">${label}</div>
        <div class="value">${value}</div>
        <div class="delta">
          <span class="pill ${pill.cls}">${pill.text}</span>
          <span>${escapeHtml(delta)}</span>
        </div>
      `;
      return d;
    }

    function renderTable(list, period){
      const tbody = document.getElementById("rows");
      tbody.innerHTML = "";

      list.forEach(ind => {
        const signClass = (score(ind) > 0) ? "good" : (score(ind) < 0) ? "bad" : "warn";
        const liveMark = ind.isLive ? " • BCB" : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="font-weight:850; letter-spacing:.01em;">${escapeHtml(ind.name)}<span class="muted small">${liveMark}</span></div>
            <div class="muted small">Horizonte: ${PERIODS[period].label}</div>
          </td>
          <td class="muted">${catLabel(ind.category)}</td>
          <td class="right" style="font-weight:850;">${fmt(ind.value)}</td>
          <td class="right">
            <span class="pill ${signClass}">${fmtChange(ind.changes[period], ind)}</span>
          </td>
          <td class="right">
            <canvas class="spark" width="120" height="28" data-id="${ind.id}"></canvas>
          </td>
          <td class="muted">${escapeHtml(ind.note)}</td>
        `;
        tbody.appendChild(tr);
      });

      requestAnimationFrame(() => {
        document.querySelectorAll("canvas.spark").forEach(c => {
          const id = c.getAttribute("data-id");
          const ind = INDICATORS.find(x => x.id === id);
          if(ind) drawSpark(c, ind.series);
        });
      });
    }

    function drawSpark(canvas, series){
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;

      ctx.clearRect(0,0,w,h);

      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      ctx.moveTo(0, h-1);
      ctx.lineTo(w, h-1);
      ctx.strokeStyle = "rgba(255,255,255,.20)";
      ctx.stroke();
      ctx.globalAlpha = 1;

      const min = Math.min(...series);
      const max = Math.max(...series);
      const pad = 2;

      ctx.beginPath();
      series.forEach((v,i)=>{
        const x = pad + (i/(series.length-1))*(w-2*pad);
        const y = pad + (1 - ((v-min)/Math.max(1e-9,(max-min))))*(h-2*pad);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });

      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(212,175,55,.90)";
      ctx.stroke();
    }

    function fmtChange(ch, ind){
      const isRateLike = ind && (ind.name.includes("Selic") || ind.name.includes("IPCA"));
      const s = ch > 0 ? "+" : "";
      // Selic/IPCA: delta em p.p. (aprox)
      if(isRateLike) return `${s}${fmt(round2(ch))} p.p.`;
      return `${s}${fmt(round2(ch))}%`;
    }

    function catLabel(cat){
      switch(cat){
        case "FUEL": return "Combustíveis";
        case "MACRO": return "Macro";
        case "FX": return "Câmbio";
        case "COMMOD": return "Commodities";
        case "LOG": return "Logística/Distribuição";
        default: return cat;
      }
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ============================================================
    // 5) EVENTS UI
    // ============================================================
    document.querySelectorAll(".segmented button").forEach(btn=>{
      btn.addEventListener("click", () => {
        document.querySelectorAll(".segmented button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        state.period = btn.getAttribute("data-period");
        render();
      });
    });

    document.getElementById("category").addEventListener("change", (e)=>{
      state.category = e.target.value;
      render();
    });

    document.getElementById("search").addEventListener("input", (e)=>{
      state.search = e.target.value;
      render();
    });

    document.querySelectorAll("#quickFilters .chip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        document.querySelectorAll("#quickFilters .chip").forEach(c=>c.classList.remove("active"));
        chip.classList.add("active");
        state.preset = chip.getAttribute("data-preset");
        render();
      });
    });

    document.getElementById("refreshLive").addEventListener("click", async ()=>{
      await refreshLive();
    });

    async function refreshLive(){
      const btn = document.getElementById("refreshLive");
      const prev = btn.textContent;
      btn.textContent = "Atualizando...";
      btn.disabled = true;

      try{
        await hydrateFromBCB();
      } catch(e){
        console.error(e);
        // se falhar, não derruba o painel
        document.getElementById("asOf").textContent = "As of: erro ao consultar BCB (ver console)";
      } finally{
        btn.textContent = prev;
        btn.disabled = false;
        render();
      }
    }

    // ============================================================
    // 6) INIT
    // ============================================================
    (async function init(){
      // inicia com timestamp e placeholders
      document.getElementById("asOf").textContent = "As of: " + nowStamp();

      // carrega live BCB (se der erro, fica com placeholders)
      await refreshLive();
    })();
  </script>
</body>
</html>

